project intro/gcc ;

import alias ;
import errors ;
import feature ;
import make ;
import regex ;
import "$(INTRO_ROOT_DIR)/compilers" ;

rule assert-specified ( feature : properties * )
{
  local val = [ feature.get-values $(feature) : $(properties) ] ;
  if $(val) = unspecified {
    errors.error $(feature) is not specified for GCC build. ;
  }
}

rule assert-unspecified ( feature : properties * )
{
  local val = [ feature.get-values $(feature) : $(properties) ] ;
  if $(val) != unspecified {
    errors.error $(feature) is not valid for GCC build. ;
  }
}


for local version in [ "$(INTRO_ROOT_DIR)/compilers.get-gcc-versions" $(COMPILERS) ]
{
  make "$(INTRO_ROOT_DIR)/gcc-$(version).tar.bz2" : : @download ;
  explicit "$(INTRO_ROOT_DIR)/gcc-$(version).tar.bz2" ;
}

rule download ( targets * : sources * : properties * )
{
  if $(sources[1])
  {
    errors.error "a wrong number of sources." ;
  }
  assert-unspecified <triplet>         : $(properties) ;
  assert-unspecified <multilib>        : $(properties) ;
  assert-unspecified <multilib-hidden> : $(properties) ;
  assert-unspecified <binutils>        : $(properties) ;
  assert-unspecified <binutils-hidden> : $(properties) ;
  assert-unspecified <gmp>             : $(properties) ;
  assert-unspecified <gmp-hidden>      : $(properties) ;
  assert-unspecified <mpfr>            : $(properties) ;
  assert-unspecified <mpfr-hidden>     : $(properties) ;
  assert-unspecified <mpc>             : $(properties) ;
  assert-unspecified <mpc-hidden>      : $(properties) ;
  assert-unspecified <ppl>             : $(properties) ;
  assert-unspecified <ppl-hidden>      : $(properties) ;
  assert-unspecified <cloog>           : $(properties) ;
  assert-unspecified <cloog-hidden>    : $(properties) ;
  assert-unspecified <compiler>        : $(properties) ;
  assert-specified   <compiler-hidden> : $(properties) ;
  assert-unspecified <icu4c>           : $(properties) ;
  assert-unspecified <icu4c-hidden>    : $(properties) ;
  assert-unspecified <mpi>             : $(properties) ;
  assert-unspecified <mpi-hidden>      : $(properties) ;
  assert-unspecified <openmpi>         : $(properties) ;
  assert-unspecified <openmpi-hidden>  : $(properties) ;
  assert-unspecified <boost>           : $(properties) ;
  assert-unspecified <boost-hidden>    : $(properties) ;
  local compiler = [ feature.get-values <compiler-hidden> : $(properties) ] ;
  if ! [ "$(INTRO_ROOT_DIR)/compilers.is-gcc" "$(compiler)" ]
  {
    errors.error "an internal error." ;
  }
  local version = [ "$(INTRO_ROOT_DIR)/compilers.get-version" $(compiler) ] ;
  VERSION on $(targets) = $(version) ;
  local url_prefix = "http://ftp.dti.ad.jp/pub/lang/gcc" ;          # Japan ++
  #local url_prefix = "http://ftp.tsukuba.wide.ad.jp/software/gcc" ; # Japan +++
  if [ "$(INTRO_ROOT_DIR)/compilers.is-gcc-release" $(compiler) ]
  {
    URL on $(targets) = "$(url_prefix)/releases/gcc-$(version)/gcc-$(version).tar.bz2" ;
  }
  else if [ "$(INTRO_ROOT_DIR)/compilers.is-gcc-snapshot" $(compiler) ]
  {
    URL on $(targets) = "$(url_prefix)/snapshots/$(version)/gcc-$(version).tar.bz2" ;
  }
  else {
    errors.error "an internal error." ;
  }
}
actions download
{
  rm -rf "$(<)" || exit $?
  if [ -n "$(STREAM)" ]; then
    ( cd "$(<:D)" && wget -- '$(URL)' >> "$(STREAM)" 2>&1 )
  else
    ( cd "$(<:D)" && wget --quiet -- '$(URL)' )
  fi
  if [ $? -ne 0 ]; then
    echo "ERROR: failed to download GCC $(VERSION) tarball." 1>&2
    echo -n "ERROR: failed to download GCC $(VERSION) tarball." | $(AWACS)
    rm -rf "$(<)"
    exit 1
  fi
  [ -f "$(<)" ] || exit 1
  exit 0
}


for local version in [ "$(INTRO_ROOT_DIR)/compilers.get-gcc-versions" $(COMPILERS) ]
{
  # Use `README' file as a target representing the completion of
  # decompression action. It is suitable for the purpose because of the
  # following reasons;
  #
  #   - The name of this file is considered stable even if the version
  #     changes.
  #   - This file won't be modified during the build procedure.
  #
  make "$(INTRO_ROOT_DIR)/gcc-$(version)/README"
    : "$(INTRO_ROOT_DIR)/gcc-$(version).tar.bz2"
    : @expand
    ;
  explicit "$(INTRO_ROOT_DIR)/gcc-$(version)/README" ;
}

rule expand ( targets * : sources * : properties * )
{
  if ! $(sources[1])
  {
    errors.error "an internal error." ;
  }
  if $(sources[2])
  {
    errors.error "an internal error." ;
  }
  assert-unspecified <triplet>         : $(properties) ;
  assert-unspecified <multilib>        : $(properties) ;
  assert-unspecified <multilib-hidden> : $(properties) ;
  assert-unspecified <binutils>        : $(properties) ;
  assert-unspecified <binutils-hidden> : $(properties) ;
  assert-unspecified <gmp>             : $(properties) ;
  assert-unspecified <gmp-hidden>      : $(properties) ;
  assert-unspecified <mpfr>            : $(properties) ;
  assert-unspecified <mpfr-hidden>     : $(properties) ;
  assert-unspecified <mpc>             : $(properties) ;
  assert-unspecified <mpc-hidden>      : $(properties) ;
  assert-unspecified <ppl>             : $(properties) ;
  assert-unspecified <ppl-hidden>      : $(properties) ;
  assert-unspecified <cloog>           : $(properties) ;
  assert-unspecified <cloog-hidden>    : $(properties) ;
  assert-unspecified <compiler>        : $(properties) ;
  assert-specified   <compiler-hidden> : $(properties) ;
  assert-unspecified <icu4c>           : $(properties) ;
  assert-unspecified <icu4c-hidden>    : $(properties) ;
  assert-unspecified <mpi>             : $(properties) ;
  assert-unspecified <mpi-hidden>      : $(properties) ;
  assert-unspecified <openmpi>         : $(properties) ;
  assert-unspecified <openmpi-hidden>  : $(properties) ;
  assert-unspecified <boost>           : $(properties) ;
  assert-unspecified <boost-hidden>    : $(properties) ;
  local compiler = [ feature.get-values <compiler-hidden> : $(properties) ] ;
  if ! [ "$(INTRO_ROOT_DIR)/compilers.is-gcc" "$(compiler)" ]
  {
    errors.error "an internal error." ;
  }
  local version = [ "$(INTRO_ROOT_DIR)/compilers.get-version" $(compiler) ] ;
  VERSION on $(targets) = $(version) ;
}
actions expand
{
  rm -rf "$(<:D)" || exit 1
  [ -f "$(>)" ] || exit 1
  if [ -n "$(STREAM)" ]; then
    tar xjvf "$(>)" --directory="$(INTRO_ROOT_DIR)" >> "$(STREAM)" 2>&1
  else
    tar xjf "$(>)" --directory="$(INTRO_ROOT_DIR)"
  fi
  if [ $? -ne 0 ]; then
    echo "ERROR: failed to expand GCC $(VERSION) tarball." 1>&2
    echo -n "ERROR: failed to expand GCC $(VERSION) tarball." | $(AWACS)
    rm -rf "$(<:D)"
    exit 1
  fi
  # If the timestamp of the tarball's contents is restored, the modification
  # time of the source directory could be older than the one of the tarball.
  # Such behavior is not desirable because the decompression always happens.
  # Therefore, `touch' is required.
  touch --no-create "$(<)"
  [ -f "$(<)" ] || exit 1
  exit 0
}


rule srcdir-req ( properties * )
{
  assert-unspecified <triplet>         : $(properties) ;
  assert-unspecified <multilib>        : $(properties) ;
  assert-unspecified <multilib-hidden> : $(properties) ;
  assert-unspecified <binutils>        : $(properties) ;
  assert-unspecified <binutils-hidden> : $(properties) ;
  assert-unspecified <gmp>             : $(properties) ;
  assert-unspecified <gmp-hidden>      : $(properties) ;
  assert-unspecified <mpfr>            : $(properties) ;
  assert-unspecified <mpfr-hidden>     : $(properties) ;
  assert-unspecified <mpc>             : $(properties) ;
  assert-unspecified <mpc-hidden>      : $(properties) ;
  assert-unspecified <ppl>             : $(properties) ;
  assert-unspecified <ppl-hidden>      : $(properties) ;
  assert-unspecified <cloog>           : $(properties) ;
  assert-unspecified <cloog-hidden>    : $(properties) ;
  assert-specified   <compiler>        : $(properties) ;
  assert-unspecified <compiler-hidden> : $(properties) ;
  assert-unspecified <icu4c>           : $(properties) ;
  assert-unspecified <icu4c-hidden>    : $(properties) ;
  assert-unspecified <mpi>             : $(properties) ;
  assert-unspecified <mpi-hidden>      : $(properties) ;
  assert-unspecified <openmpi>         : $(properties) ;
  assert-unspecified <openmpi-hidden>  : $(properties) ;
  assert-unspecified <boost>           : $(properties) ;
  assert-unspecified <boost-hidden>    : $(properties) ;
  local compiler = [ feature.get-values <compiler> : $(properties) ] ;
  if ! [ "$(INTRO_ROOT_DIR)/compilers.is-gcc" "$(compiler)" ]
  {
    errors.error "an internal error." ;
  }
  local version = [ "$(INTRO_ROOT_DIR)/compilers.get-version" $(compiler) ] ;
  return <source>"$(INTRO_ROOT_DIR)/gcc-$(version)/README/<compiler>unspecified/<compiler-hidden>$(compiler)" ;
}

alias srcdir : : <conditional>@srcdir-req ;
explicit srcdir ;


for local compiler in $(COMPILERS)
{
  local prefix-leaf = [ "$(INTRO_ROOT_DIR)/compilers.get-prefix-leaf" "$(compiler)" : "$(GCC_FOR_CLANG)" ] ;
  local compiler-prefix = "$(PREFIX)/$(prefix-leaf)" ;
  if [ "$(INTRO_ROOT_DIR)/compilers.is-gcc" $(compiler) ]
  {
    make "$(compiler-prefix)/bin/g++-wrapper"
      : ../binutils//srcdir/<triplet>unspecified/<multilib>unspecified/<binutils>$(BINUTILS)/<compiler>unspecified
        ../gmp//srcdir/<triplet>unspecified/<multilib>unspecified/<gmp>$(GMP_FOR_GCC)/<compiler>unspecified
        ../mpfr//srcdir/<triplet>unspecified/<multilib>unspecified/<mpfr>$(MPFR_FOR_GCC)/<compiler>unspecified
        ../mpc//srcdir/<triplet>unspecified/<multilib>unspecified/<mpc>$(MPC_FOR_GCC)/<compiler>unspecified
        ../ppl//srcdir/<triplet>unspecified/<multilib>unspecified/<ppl>$(PPL_FOR_GCC)/<compiler>unspecified
        ../cloog//srcdir/<triplet>unspecified/<multilib>unspecified/<cloog>$(CLOOG_FOR_GCC)/<compiler>unspecified
        srcdir/<triplet>unspecified/<multilib>unspecified
      : @make-install
      ;
  }
  else if [ "$(INTRO_ROOT_DIR)/compilers.is-clang" $(compiler) ]
  {
    if ! $(GCC_FOR_CLANG)
    {
      errors.error "an internal error." ;
    }
    make "$(compiler-prefix)/bin/g++-wrapper"
      : ../binutils//srcdir/<triplet>unspecified/<multilib>unspecified/<binutils>$(BINUTILS)/<compiler>unspecified
        ../gmp//srcdir/<triplet>unspecified/<multilib>unspecified/<gmp>$(GMP_FOR_GCC)/<compiler>unspecified
        ../mpfr//srcdir/<triplet>unspecified/<multilib>unspecified/<mpfr>$(MPFR_FOR_GCC)/<compiler>unspecified
        ../mpc//srcdir/<triplet>unspecified/<multilib>unspecified/<mpc>$(MPC_FOR_GCC)/<compiler>unspecified
        ../ppl//srcdir/<triplet>unspecified/<multilib>unspecified/<ppl>$(PPL_FOR_GCC)/<compiler>unspecified
        ../cloog//srcdir/<triplet>unspecified/<multilib>unspecified/<cloog>$(CLOOG_FOR_GCC)/<compiler>unspecified
        srcdir/<triplet>unspecified/<multilib>unspecified/<compiler>$(GCC_FOR_CLANG)
      : @make-install
      ;
  }
  else
  {
    errors.error "an internal error." ;
  }
  explicit "$(compiler-prefix)/bin/g++-wrapper" ;
}

rule make-install ( targets * : sources * : properties * )
{
  assert-specified   <triplet>         : $(properties) ;
  assert-specified   <multilib>        : $(properties) ;
  assert-unspecified <multilib-hidden> : $(properties) ;
  assert-unspecified <binutils>        : $(properties) ;
  assert-unspecified <binutils-hidden> : $(properties) ;
  assert-unspecified <gmp>             : $(properties) ;
  assert-unspecified <gmp-hidden>      : $(properties) ;
  assert-unspecified <mpfr>            : $(properties) ;
  assert-unspecified <mpfr-hidden>     : $(properties) ;
  assert-unspecified <mpc>             : $(properties) ;
  assert-unspecified <mpc-hidden>      : $(properties) ;
  assert-unspecified <ppl>             : $(properties) ;
  assert-unspecified <ppl-hidden>      : $(properties) ;
  assert-unspecified <cloog>           : $(properties) ;
  assert-unspecified <cloog-hidden>    : $(properties) ;
  assert-specified   <compiler>        : $(properties) ;
  assert-unspecified <compiler-hidden> : $(properties) ;
  assert-unspecified <icu4c>           : $(properties) ;
  assert-unspecified <icu4c-hidden>    : $(properties) ;
  assert-unspecified <mpi>             : $(properties) ;
  assert-unspecified <mpi-hidden>      : $(properties) ;
  assert-unspecified <openmpi>         : $(properties) ;
  assert-unspecified <openmpi-hidden>  : $(properties) ;
  assert-unspecified <boost>           : $(properties) ;
  assert-unspecified <boost-hidden>    : $(properties) ;

  local compiler = [ feature.get-values <compiler> : $(properties) ] ;
  local version ;
  local compiler-description ;
  if [ "$(INTRO_ROOT_DIR)/compilers.is-gcc" $(compiler) ]
  {
    version = [ "$(INTRO_ROOT_DIR)/compilers.get-version" $(compiler) ] ;
    compiler-description = [ "$(INTRO_ROOT_DIR)/compilers.get-compiler-description" $(compiler) ] ;
  }
  else if [ "$(INTRO_ROOT_DIR)/compilers.is-clang" $(compiler) ]
  {
    version = [ "$(INTRO_ROOT_DIR)/compilers.get-version" $(GCC_FOR_CLANG) ] ;
    compiler-description = [ "$(INTRO_ROOT_DIR)/compilers.get-compiler-description" $(GCC_FOR_CLANG) ] ;
  }
  else
  {
    errors.error "an internal error." ;
  }
  COMPILER_DESCRIPTION on $(targets) = "$(compiler-description)" ;

  local srcdir = "$(INTRO_ROOT_DIR)/gcc-$(version)" ;
  SRCDIR on $(targets) = "$(srcdir)" ;

  local objdir = "$(INTRO_ROOT_DIR)/objdir" ;
  OBJDIR on $(targets) = "$(objdir)" ;

  # Set the compiler-specific prefix.
  local prefix-leaf = [ "$(INTRO_ROOT_DIR)/compilers.get-prefix-leaf" $(compiler) : $(GCC_FOR_CLANG) ] ;
  local compiler-prefix = "$(PREFIX)/$(prefix-leaf)" ;
  COMPILER_PREFIX on $(targets) = "$(compiler-prefix)" ;

  local libdir = "$(compiler-prefix)/lib" ;
  LIBDIR on $(targets) = "$(libdir)" ;

  local triplet = [ feature.get-values <triplet> : $(properties) ] ;
  TRIPLET on $(targets) = $(triplet) ;

  OPTIONS on $(targets) = ;

  # Set the '--build', '--host' and '--target' options for the 'configure' script.
  OPTIONS on $(targets) += --build=$(triplet) ;
  OPTIONS on $(targets) += --host=$(triplet) ;
  OPTIONS on $(targets) += --target=$(triplet) ;

  # Set the '--prefix' option for the 'configure' script.
  OPTIONS on $(targets) += "--prefix=\"$(compiler-prefix)\"" ;

  # Set the build variants of runtime libraries.
  OPTIONS on $(targets) += --enable-static ;
  OPTIONS on $(targets) += --enable-shared ;

  # Set the linker configuration to be used by the installed GCC front-end.
  #
  # gold linker has a bug that ignores `LD_RUN_PATH' environment variable.
  # http://sourceware.org/bugzilla/show_bug.cgi?id=13764
  # If the day comes when this bug is fixed, gold can become the default
  # linker.
  OPTIONS on $(targets) += --enable-ld=default ;
  OPTIONS on $(targets) += --enable-gold ;

  local multilib = [ feature.get-values <multilib> : $(properties) ] ;
  if $(multilib) = yes
  {
    OPTIONS on $(targets) += --enable-multilib ;
  }
  else
  {
    OPTIONS on $(targets) += --disable-multilib ;
  }

  if $(triplet) = i686-w64-mingw32 || $(triplet) = x86_64-w64-mingw32
  {
    OPTIONS on $(targets) += --enable-threads=win32 ;
  }
  else
  {
    OPTIONS on $(targets) += --enable-threads=posix ;
  }

  OPTIONS on $(targets) += --enable-tls ;

  if $(triplet) = i686-pc-linux-gnu || $(triplet) = i686-pc-cygwin || $(triplet) = i686-w64-mingw32
  {
    OPTIONS on $(targets) += --with-arch=i686 ;
    OPTIONS on $(targets) += --with-tune=generic ;
  }
  else if $(triplet) = x86_64-unknown-linux-gnu || $(triplet) = x86_64-w64-mingw32
  {
    OPTIONS on $(targets) += --with-arch-32=i686 ;
    OPTIONS on $(targets) += --with-tune=generic ;
  }

  if $(triplet) = i686-pc-cygwin
  {
    OPTIONS on $(targets) += --disable-__cxa_atexit ;
  }

  # This option is a workaround required to build PPL and CLooG alongside
  # during GCC bootstrap.
  OPTIONS on $(targets) += --enable-build-with-cxx ;

  OPTIONS on $(targets) += --enable-bootstrap ;

  OPTIONS on $(targets) += --enable-languages=c,c++ ;

  OPTIONS on $(targets) += --enable-libssp ;

  if $(triplet) = i686-w64-mingw32 || $(triplet) = x86_64-w64-mingw32
  {
    # The target is `*-w64-mingw32.'
    # `--enable-libgomp' option requires `pthreads-w32' on the target.
    # Currently, just disable this option.
    OPTIONS on $(targets) += --disable-libgomp ;
  }
  else
  {
    OPTIONS on $(targets) += --enable-libgomp ;
  }

  if $(triplet) = i686-pc-cygwin || $(triplet) = i686-w64-mingw32
  {
    OPTIONS on $(targets) += --with-dwarf2 ;
    OPTIONS on $(targets) += --disable-sjlj-exceptions ;
  }
  # `--with-dwarf2' is not supported on `x86_64-w64-mingw32' targets.

  if $(multilib) = yes
  {
    if $(triplet) = x86_64-unknown-linux-gnu || $(triplet) = x86_64-w64-mingw32
    {
      OPTIONS on $(targets) += --enable-targets=all ;
    }
  }

  if $(triplet) = i686-w64-mingw32 || $(triplet) = x86_64-w64-mingw32
  {
    OPTIONS on $(targets) += --disable-win32-registry ;
  }

  OPTIONS on $(targets) += --disable-nls ;

  if $(triplet) = i686-pc-cygwin
  {
    OPTIONS on $(targets) += --enable-graphite ;
  }

  OPTIONS on $(targets) += --enable-cloog-backend=isl ;

  OPTIONS on $(targets) += --with-stage1-ldflags=-lstdc++ ;

  OPTIONS on $(targets) += --enable-linker-build-id ;

  OPTIONS on $(targets) += --enable-lto ;

  OPTIONS on $(targets) += --enable-plugins ;

  OPTIONS on $(targets) += --enable-libstdcxx-time=yes ;

  OPTIONS on $(targets) += --enable-libstdcxx-debug ;

  SET_PREFIX_SYMLINK on $(targets) = ;
  if $(triplet) = x86_64-unknown-linux-gnu || $(triplet) = x86_64-w64-mingw32
  {
    SET_PREFIX_SYMLINK on $(targets) = "{ mkdir -p \"$(compiler-prefix)/lib\" && ( cd \"$(compiler-prefix)\" && ln -sfT lib lib64 ); } || exit 1" ;
  }

  ENV_FOR_MAKE on $(targets) = env ;
  ENV_FOR_MAKE on $(targets) += "CPATH=\"$(objdir)/gmp:$(srcdir)/gmp${CPATH:+:$CPATH}\"" ;
  ENV_FOR_MAKE on $(targets) += "LIBRARY_PATH=\"$(objdir)/gmp/.libs:$(objdir)/$(triplet)/libstdc++-v3/src/.libs${LIBRARY_PATH:+:$LIBRARY_PATH}\"" ;
  ENV_FOR_MAKE on $(targets) += "LD_RUN_PATH=\"$(libdir)${LD_RUN_PATH:+:$LD_RUN_PATH}\"" ;
}
actions make-install
{
  # Clean-up the OBJDIR.
  { mkdir -p "$(OBJDIR)" && ( cd "$(OBJDIR)" && rm -rf * ); } || exit 1


  # Create the symlinks to the source directories to GNU Binutils
  # libraries and tools (opcodes, bfd, binutils, gas, ld, gold, gprof) in
  # the GCC source directory.
  ( cd "$(SRCDIR)"                               \
      && ln -sf ../binutils-$(BINUTILS)/bfd      \
                ../binutils-$(BINUTILS)/binutils \
                ../binutils-$(BINUTILS)/gas      \
                ../binutils-$(BINUTILS)/gold     \
                ../binutils-$(BINUTILS)/gprof    \
                ../binutils-$(BINUTILS)/ld       \
                ../binutils-$(BINUTILS)/opcodes  . ) || exit 1


  # Create the symlink to the GMP source directory.
  ( cd "$(SRCDIR)" && ln -sfT ../gmp-$(GMP_FOR_GCC) gmp ) || exit 1

  # An ad-hoc workaround that forces the GCC bootstrap procedure to build
  # GMP C++ bindings, which are necessary to build PPL and CLooG.
  if [ ! -e "$(SRCDIR)/gmp/real-configure" ]; then
    ( cd "$(SRCDIR)" && mv gmp/configure gmp/real-configure ) || exit 1
  fi
  echo '#! /bin/sh'                                          >  "$(SRCDIR)/gmp/configure"
  echo ""                                                    >> "$(SRCDIR)/gmp/configure"
  echo "echo original options for GMP configure script: \$@" >> "$(SRCDIR)/gmp/configure"
  echo "dir=\`dirname \"\$0\"\`"                             >> "$(SRCDIR)/gmp/configure"
  #echo "\"\${dir}/real-configure\" --enable-cxx \"\$@\""    >> "$(SRCDIR)/gmp/configure"
  echo "\"\${dir}/real-configure\" --srcdir=\"$(SRCDIR)/gmp\" --build=$(TRIPLET) --host=$(TRIPLET) --enable-cxx --enable-static --disable-shared" >> "$(SRCDIR)/gmp/configure"
  chmod +x "$(SRCDIR)/gmp/configure"


  # Create the symlink to the MPFR source directory.
  ( cd "$(SRCDIR)" && ln -sfT ../mpfr-$(MPFR_FOR_GCC) mpfr ) || exit 1


  # Create the symlink to the MPC source directory.
  ( cd "$(SRCDIR)" && ln -sfT ../mpc-$(MPC_FOR_GCC) mpc ) || exit 1


  # Create the symlink to the PPL source directory in the GCC source
  # directory.
  ( cd "$(SRCDIR)" && ln -sfT ../ppl-$(PPL_FOR_GCC) ppl ) || exit 1

  # An ad-hoc workaround that enables the PPL configure script to find the
  # GMP build directory during the GCC bootstrap procedure.
  if [ ! -e "$(SRCDIR)/ppl/real-configure" ]; then
    ( cd "$(SRCDIR)" && mv ppl/configure ppl/real-configure ) || exit 1
  fi
  echo '#! /bin/sh'                                                             >  "$(SRCDIR)/ppl/configure"
  echo ""                                                                       >> "$(SRCDIR)/ppl/configure"
  echo "echo original options for PPL configure script: \$@"                    >> "$(SRCDIR)/ppl/configure"
  echo "dir=\`dirname \"\$0\"\`"                                                >> "$(SRCDIR)/ppl/configure"
  #echo "\"\${dir}/real-configure\" --with-gmp-build=\"$(OBJDIR)/gmp\" \"\$@\"" >> "$(SRCDIR)/ppl/configure"
  echo  "\"\${dir}/real-configure\" --srcdir="$(SRCDIR)/ppl" --build=$(TRIPLET) --host=$(TRIPLET) --disable-coverage --enable-static --disable-shared --with-gmp-build=\"$(OBJDIR)/gmp\"" >> "$(SRCDIR)/ppl/configure"
  chmod +x "$(SRCDIR)/ppl/configure"


  # Create the symlink to the CLooG source directory in the GCC source
  # directory.
  ( cd "$(SRCDIR)" && ln -sfT ../cloog-$(CLOOG_FOR_GCC) cloog ) || exit 1

  # An ad-hoc workaround that enables the CLooG configure script to find
  # the GMP build directory during the GCC bootstrap procedure.
  if [ ! -e "$(SRCDIR)/cloog/real-configure" ]; then
    ( cd "$(SRCDIR)" && mv cloog/configure cloog/real-configure ) || exit 1
  fi
  echo '#! /bin/sh'                                                               >  "$(SRCDIR)/cloog/configure"
  echo ""                                                                         >> "$(SRCDIR)/cloog/configure"
  echo "echo original options for CLooG configure script: \$@"                    >> "$(SRCDIR)/cloog/configure"
  echo "dir=\`dirname \"\$0\"\`"                                                  >> "$(SRCDIR)/cloog/configure"
  #echo "\"\${dir}/real-configure\" --with-gmp-builddir=\"$(OBJDIR)/gmp\" \"\$@\"" >> "$(SRCDIR)/cloog/configure"
  echo "\"\${dir}/real-configure\" --srcdir=$(SRCDIR)/cloog --build=$(TRIPLET) --host=$(TRIPLET) --enable-static --disable-shared --with-gnu-ld --with-gmp-builddir=\"$(OBJDIR)/gmp\"" >> "$(SRCDIR)/cloog/configure"
  chmod +x "$(SRCDIR)/cloog/configure"


  [ -x "$(SRCDIR)/configure" ] || exit 1
  [ -x "$(SRCDIR)/config.sub" ] || exit 1
  [ `"$(SRCDIR)/config.sub" $(TRIPLET)` = $(TRIPLET) ] || exit 1

  $(SET_PREFIX_SYMLINK)


  # `configure'.
  if [ -n "$(STREAM)" ]; then
    ( cd "$(OBJDIR)" && env LD_RUN_PATH="$(LIBDIR)${LD_RUN_PATH:+:$LD_RUN_PATH}" "$(SRCDIR)/configure" $(OPTIONS) >> "$(STREAM)" 2>&1 )
  else
    ( cd "$(OBJDIR)" && env LD_RUN_PATH="$(LIBDIR)${LD_RUN_PATH:+:$LD_RUN_PATH}" "$(SRCDIR)/configure" $(OPTIONS) )
  fi
  if [ $? -ne 0 ]; then
    echo "ERROR: failed to 'configure' $(COMPILER_DESCRIPTION) ($(TRIPLET))." 1>&2
    echo -n "ERROR: failed to 'configure' $(COMPILER_DESCRIPTION) ($(TRIPLET))." | $(AWACS)
    exit 1
  fi

  # Check the creation of `Makefile'.
  [ -f "$(OBJDIR)/Makefile" ] || exit 1


  # PPL and CLooG requires GMP. However, they will fail to find the GMP
  # header files, `<gmp.h>' and `<gmpxx.h>'. `<gmp.h>' will be created in
  # `$(OBJDIR)/gmp' during the bootstrap procedure, whereas `<gmpxx.h>'
  # resides in `$(SRCDIR)/gmp'. So, `CPATH' environment variable is set
  # to include the paths to those header files.
  if [ -n "$(STREAM)" ]; then
    ( cd "$(OBJDIR)" && $(ENV_FOR_MAKE) make --jobs=$(CONCURRENCY) >> "$(STREAM)" 2>&1 )
    if [ $? -ne 0 ]; then
      ( cd "$(OBJDIR)" && $(ENV_FOR_MAKE) make --jobs=$(CONCURRENCY) >> "$(STREAM)" 2>&1 )
      if [ $? -ne 0 ]; then
        ( cd "$(OBJDIR)" && $(ENV_FOR_MAKE) make --jobs=$(CONCURRENCY) >> "$(STREAM)" 2>&1 )
      fi
    fi
  else
    ( cd "$(OBJDIR)" && $(ENV_FOR_MAKE) make --jobs=$(CONCURRENCY) )
    if [ $? -ne 0 ]; then
      ( cd "$(OBJDIR)" && $(ENV_FOR_MAKE) make --jobs=$(CONCURRENCY) )
      if [ $? -ne 0 ]; then
        ( cd "$(OBJDIR)" && $(ENV_FOR_MAKE) make --jobs=$(CONCURRENCY) )
      fi
    fi
  fi
  if [ $? -ne 0 ]; then
    echo "ERROR: failed to 'make' $(COMPILER_DESCRIPTION) ($(TRIPLET))." 1>&2
    echo -n "ERROR: failed to 'make' $(COMPILER_DESCRIPTION) ($(TRIPLET))." | $(AWACS)
    exit 1
  fi


  # `make install'.
  if [ -n "$(STREAM)" ]; then
    ( cd "$(OBJDIR)" && env LD_RUN_PATH="$(LIBDIR)${LD_RUN_PATH:+:$LD_RUN_PATH}" make install >> "$(STREAM)" 2>&1 )
  else
    ( cd "$(OBJDIR)" && env LD_RUN_PATH="$(LIBDIR)${LD_RUN_PATH:+:$LD_RUN_PATH}" make install )
  fi
  if [ $? -ne 0 ]; then
    echo "ERROR: failed to 'make install' $(COMPILER_DESCRIPTION) ($(TRIPLET))." 1>&2
    echo -n "ERROR: failed to 'make install' $(COMPILER_DESCRIPTION) ($(TRIPLET))." | $(AWACS)
    exit 1
  fi


  # A workaround. Create a symlink to `ld' in the directory where the
  # installed GCC front end searches for subprograms.
  ( cd "$(COMPILER_PREFIX)"/libexec/gcc/$(TRIPLET)/`"$(COMPILER_PREFIX)/bin/gcc" -dumpversion` && ln -sf ../../../../bin/ld real-ld )
  if [ $? -ne 0 ]; then
    echo "ERROR: failed to create the workaround symlink to the linker for $(COMPILER_DESCRIPTION) ($(TRIPLET))." 1>&2
    echo -n "ERROR: failed to create the workaround symlink to the linker for $(COMPILER_DESCRIPTION) ($(TRIPLET))." | $(AWACS)
    exit 1
  fi
  # Some configure scripts (e.g. MPC's) require `ld' instead of `real-ld'.
  ( cd "$(COMPILER_PREFIX)"/libexec/gcc/$(TRIPLET)/`"$(COMPILER_PREFIX)/bin/gcc" -dumpversion` && ln -sf ../../../../bin/ld ld )
  if [ $? -ne 0 ]; then
    echo "ERROR: failed to create the workaround symlink to the linker for $(COMPILER_DESCRIPTION) ($(TRIPLET))." 1>&2
    echo -n "ERROR: failed to create the workaround symlink to the linker for $(COMPILER_DESCRIPTION) ($(TRIPLET))." | $(AWACS)
    exit 1
  fi


  # Install the wrapper scripts.
  install --mode=755 "$(INTRO_ROOT_DIR)/gcc/gcc-wrapper" "$(INTRO_ROOT_DIR)/gcc/g++-wrapper" "$(COMPILER_PREFIX)/bin"
  if [ $? -ne 0 ]; then
    echo "ERROR: failed to install the wrapper scripts for $(COMPILER_DESCRIPTION) ($(TRIPLET))." 1>&2
    echo -n "ERROR: failed to install the wrapper scripts for $(COMPILER_DESCRIPTION) ($(TRIPLET))." | $(AWACS)
    exit 1
  fi


  # Check the creation of `g++-wrapper'.
  [ -x "$(<)" ] || exit 1

  # Clean-up the OBJDIR.
  rm -rf "$(OBJDIR)" || exit 1

  echo -n "$(COMPILER_DESCRIPTION) ($(TRIPLET)) was successfully built." | $(AWACS)
  echo -n "NOTE: Binutils $(BINUTILS), GMP $(GMP_FOR_GCC), MPFR $(MPFR_FOR_GCC), MPC $(MPC_FOR_GCC), PPL $(PPL_FOR_GCC), CLooG $(CLOOG_FOR_GCC) were bootstrapped alongside." | $(AWACS)
  exit 0
}


rule install-req ( properties * )
{
  assert-specified   <triplet>         : $(properties) ;
  assert-specified   <multilib>        : $(properties) ;
  assert-unspecified <multilib-hidden> : $(properties) ;
  assert-unspecified <binutils>        : $(properties) ;
  assert-unspecified <binutils-hidden> : $(properties) ;
  assert-unspecified <gmp>             : $(properties) ;
  assert-unspecified <gmp-hidden>      : $(properties) ;
  assert-unspecified <mpfr>            : $(properties) ;
  assert-unspecified <mpfr-hidden>     : $(properties) ;
  assert-unspecified <mpc>             : $(properties) ;
  assert-unspecified <mpc-hidden>      : $(properties) ;
  assert-unspecified <ppl>             : $(properties) ;
  assert-unspecified <ppl-hidden>      : $(properties) ;
  assert-unspecified <cloog>           : $(properties) ;
  assert-unspecified <cloog-hidden>    : $(properties) ;
  assert-specified   <compiler>        : $(properties) ;
  assert-unspecified <compiler-hidden> : $(properties) ;
  assert-unspecified <icu4c>           : $(properties) ;
  assert-unspecified <icu4c-hidden>    : $(properties) ;
  assert-unspecified <mpi>             : $(properties) ;
  assert-unspecified <mpi-hidden>      : $(properties) ;
  assert-unspecified <openmpi>         : $(properties) ;
  assert-unspecified <openmpi-hidden>  : $(properties) ;
  assert-unspecified <boost>           : $(properties) ;
  assert-unspecified <boost-hidden>    : $(properties) ;
  local compiler = [ feature.get-values <compiler> : $(properties) ] ;
  local prefix-leaf = [ "$(INTRO_ROOT_DIR)/compilers.get-prefix-leaf" $(compiler) : $(GCC_FOR_CLANG) ] ;
  local compiler-prefix = "$(PREFIX)/$(prefix-leaf)" ;
  return <source>"$(compiler-prefix)/bin/g++-wrapper" ;
}

alias install : : <conditional>@install-req ;
explicit install ;
